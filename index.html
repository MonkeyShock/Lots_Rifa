<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Medida de Seguran√ßa: Content Security Policy (CORRIGIDA) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://*.firebaseio.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://www.google.com; connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com https://identitytoolkit.googleapis.com https://firestore.googleapis.com;">
    <title>RIFA LOTS 2025 - Sua Chance de Ganhar!</title>
    <!-- √çcone da Aba do Navegador (Favicon) -->
    <link rel="icon" href="image-Photoroom.png" type="image/png">
    <meta name="description" content="RIFA LOTS 2025 - Apenas R$1 por n√∫mero! Pr√™mios: R$300, R$150 e R$50. Sorteio ao vivo no Instagram.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 10px 10px rgba(250, 204, 21, 0);
            }
        }
        .modal-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .modal-scrollbar::-webkit-scrollbar-track {
            background-color: #1f2937;
        }
        .modal-scrollbar::-webkit-scrollbar-thumb {
            background-color: #facc15;
            border-radius: 10px;
            border: 2px solid #1f2937;
        }
        /* Estilos para Impress√£o do Relat√≥rio */
        @media print {
            body * {
                visibility: hidden;
            }
            #reportModal, #reportContent, #reportContent * {
                visibility: visible;
            }
            #reportModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                border: none;
                box-shadow: none;
                background-color: white !important;
                color: black !important;
            }
            .report-print-area {
                color: black !important;
            }
            .report-print-area h3, .report-print-area p, .report-print-area strong {
                 color: black !important;
            }
            .report-print-area span {
                 background-color: #eee !important;
                 color: black !important;
                 border: 1px solid #ccc !important;
                 padding: 2px 4px;
                 margin: 2px;
                 display: inline-block;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- TELA DE CARREGAMENTO -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-yellow-400 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-white text-lg mt-4">Carregando dados da rifa...</p>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">

        <!-- Cabe√ßalho -->
        <header class="text-center my-8">
            <div class="flex justify-center mb-4">
                <img src="image-Photoroom.png" alt="RIFA LOTS 2025" class="w-32 h-32 md:w-40 md:h-40 object-contain">
            </div>
            <h1 class="text-4xl md:text-6xl font-black text-yellow-400 tracking-tighter" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">RIFA LOTS 2025</h1>
            <p class="text-lg md:text-xl text-gray-300 mt-2">Sua chance de ganhar est√° aqui!</p>
            <p id="raffleInfo" class="text-sm text-yellow-500 mt-2">Carregando dados da rifa...</p>
        </header>

        <!-- Banner de Urg√™ncia -->
        <div class="bg-red-600 text-white text-center p-4 rounded-xl font-bold text-lg md:text-xl my-8 pulse-animation">
            ‚è∞ APENAS 350 N√öMEROS POR RODADA - ALTA CHANCE DE GANHAR!
        </div>

        <!-- Conte√∫do Principal: Pre√ßo e Pr√™mios -->
        <main class="grid md:grid-cols-2 gap-8 my-8">
            <!-- Se√ß√£o de Pre√ßo -->
            <div class="bg-gray-800 p-8 rounded-2xl text-center border border-gray-700 shadow-2xl flex flex-col justify-center">
                <h2 class="text-2xl font-bold text-yellow-400 mb-4">üí∞ PRE√áO ESPECIAL</h2>
                <div class="my-4">
                    <span class="text-6xl font-extrabold text-yellow-300">R$ 1</span>
                    <span class="text-gray-400">/ n√∫mero</span>
                </div>
                <p class="text-gray-300">Investimento baixo, oportunidade alta!<br>Compre quantos n√∫meros quiser!</p>
            </div>

            <!-- Se√ß√£o de Pr√™mios -->
            <div class="bg-gray-800 p-8 rounded-2xl border border-gray-700 shadow-2xl">
                <h2 class="text-2xl font-bold text-yellow-400 mb-6 text-center">üèÜ PR√äMIOS</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center bg-gray-700 p-4 rounded-lg text-lg">
                        <span>ü•á 1¬∫ Lugar</span>
                        <strong class="text-yellow-300">R$ 300</strong>
                    </div>
                    <div class="flex justify-between items-center bg-gray-700 p-4 rounded-lg text-lg">
                        <span>ü•à 2¬∫ Lugar</span>
                        <strong class="text-yellow-300">R$ 150</strong>
                    </div>
                    <div class="flex justify-between items-center bg-gray-700 p-4 rounded-lg text-lg">
                        <span>ü•â 3¬∫ Lugar</span>
                        <strong class="text-yellow-300">R$ 50</strong>
                    </div>
                </div>
            </div>
        </main>

        <!-- Se√ß√£o Nossa Miss√£o -->
        <section class="bg-gray-800 p-8 rounded-2xl text-center my-8 border border-gray-700 shadow-2xl">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4">‚úàÔ∏è NOSSA MISS√ÉO: AERODESIGN</h2>
            <p class="text-gray-300 mb-6 max-w-3xl mx-auto">
                A RIFA LOTS √© uma iniciativa da nossa equipe de aerodesign da faculdade. Todo o valor arrecadado ser√° fundamental para custear os materiais, a constru√ß√£o do nosso avi√£o e a nossa participa√ß√£o em competi√ß√µes nacionais. Ao participar, voc√™ n√£o s√≥ concorre a pr√™mios incr√≠veis, mas tamb√©m nos ajuda a voar mais alto e representar nossa universidade!
            </p>
        </section>

        <!-- Se√ß√£o de Escolha de N√∫meros -->
        <section class="bg-gray-800 p-8 rounded-2xl text-center my-8 border border-gray-700 shadow-2xl">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4">üéØ ESCOLHA SEUS N√öMEROS</h2>
            <p class="text-gray-300 mb-6 max-w-2xl mx-auto">Clique no bot√£o abaixo para ver o painel com todos os n√∫meros dispon√≠veis e escolher os seus da sorte!</p>
            <button class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-4 px-8 rounded-lg text-xl transition-transform transform hover:scale-105 shadow-lg" onclick="openNumbersModal()">
                üìã VER N√öMEROS DISPON√çVEIS
            </button>
        </section>

        <!-- Se√ß√£o de Informa√ß√µes -->
        <section class="grid md:grid-cols-3 gap-8 my-8">
            <div class="bg-gray-800 p-6 rounded-2xl text-center border border-gray-700 flex flex-col">
                <h3 class="text-xl font-bold text-yellow-400 mb-2">‚ö° Alta Chance</h3>
                <p class="text-gray-300">Com apenas 350 n√∫meros, suas chances de ganhar s√£o muito maiores!</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-2xl text-center border border-gray-700 flex flex-col">
                <h3 class="text-xl font-bold text-yellow-400 mb-2">üì∫ Transpar√™ncia Total</h3>
                <p class="text-gray-300 mb-4">Sorteio realizado AO VIVO no Instagram para todos acompanharem.</p>
                <a href="https://www.instagram.com/lotsaerodesign/" target="_blank" class="mt-auto bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors">
                    Siga para Assistir
                </a>
            </div>
            <div class="bg-gray-800 p-6 rounded-2xl text-center border border-gray-700 flex flex-col">
                <h3 class="text-xl font-bold text-yellow-400 mb-2">üîí Seguro & Confi√°vel</h3>
                <p class="text-gray-300">Comprovantes e lista de ganhadores publicados ap√≥s o sorteio.</p>
            </div>
        </section>

        <!-- CTA Final -->
         <section class="text-center my-12">
            <a href="https://wa.me/5531999121383" class="bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-10 rounded-lg text-xl transition-transform transform hover:scale-105 shadow-lg inline-block" target="_blank">
                üöÄ GARANTIR MEUS N√öMEROS
            </a>
        </section>

        <!-- Rodap√© -->
        <footer class="text-center text-gray-500 py-8 mt-8 border-t border-gray-700">
            <p>&copy; 2025 RIFA LOTS - Todos os direitos reservados</p>
            <p class="text-xs mt-2">Aviso: Os n√∫meros s√£o atualizados em tempo real. A lista oficial de participantes √© a que consta no controle da organiza√ß√£o.</p>
            <p class="cursor-pointer hover:text-yellow-400 mt-2" onclick="openAdminLoginModal()">Modo Administrador</p>
        </footer>
    </div>
    
    <!-- Painel de Administrador (escondido por padr√£o) -->
    <div id="adminPanel" class="hidden fixed bottom-4 right-4 bg-gray-800 border border-yellow-400 p-4 rounded-lg shadow-lg z-50 w-64">
        <h4 class="font-bold text-yellow-400">Painel do Admin</h4>
        <p id="adminUserEmail" class="text-sm text-gray-300 mb-2 truncate"></p>
        <button id="startNewRaffleBtn" onclick="startNewRaffle()" class="w-full bg-green-600 hover:bg-green-500 text-white font-semibold py-2 px-4 rounded-md text-sm disabled:bg-gray-500 disabled:cursor-not-allowed">
            Iniciar Nova Rifa
        </button>

        <div class="mt-4 pt-4 border-t border-gray-600">
            <label for="reportRound" class="block text-sm font-medium text-gray-300">Gerar Relat√≥rio</label>
            <div class="flex items-center gap-2 mt-1">
                <input type="number" id="reportRound" name="reportRound" class="w-full bg-gray-900 text-white p-2 rounded-md border border-gray-600 text-sm" placeholder="N¬∫ da Rodada">
                <button onclick="generateReport()" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-4 rounded-md text-sm">Gerar</button>
            </div>
        </div>
        
        <div class="mt-4 pt-4 border-t border-gray-600">
            <h5 class="text-sm font-bold text-red-400 mb-2">A√ß√µes Perigosas</h5>
             <button id="finalizeRaffleBtn" onclick="finalizeRaffle()" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-semibold py-2 px-4 rounded-md text-sm mb-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
                 Finalizar Rifa Atual
            </button>
            <button onclick="resetAllData()" class="w-full bg-red-800 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md text-sm">
                Resetar TUDO
            </button>
        </div>

        <button onclick="handleAdminLogout()" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-md text-sm mt-4">
            Sair (Logout)
        </button>
    </div>

    <!-- Modal para sele√ß√£o de n√∫meros -->
    <div id="numbersModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl max-w-4xl w-full max-h-[90vh] flex flex-col shadow-2xl border border-gray-700">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h2 id="modalTitle" class="text-2xl font-bold text-yellow-400">üéØ ESCOLHA SEUS N√öMEROS</h2>
                <button class="text-3xl text-gray-400 hover:text-yellow-400" onclick="closeNumbersModal()">&times;</button>
            </div>

            <div class="p-6 flex-grow overflow-y-auto modal-scrollbar">
                <div id="selectionSummary" class="bg-gray-900 p-4 rounded-lg mb-4 text-center sticky top-0 z-10">
                    <p><strong>N√∫meros selecionados:</strong> <span id="selectedCount">0</span></p>
                    <p><strong>Total a pagar:</strong> R$ <span id="totalPrice">0,00</span></p>
                    <div id="selectedNumbersDisplay" class="mt-2 text-sm text-yellow-400 break-words"></div>
                </div>

                <div id="numbersGrid" class="grid grid-cols-5 sm:grid-cols-7 md:grid-cols-10 gap-2">
                    <!-- N√∫meros ser√£o gerados pelo JavaScript -->
                </div>
            </div>

            <div class="p-6 border-t border-gray-700">
                <button id="confirmBtn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-8 rounded-lg text-lg transition-opacity disabled:opacity-50 disabled:cursor-not-allowed" onclick="confirmSelection()" disabled>
                    üì± FINALIZAR COMPRA NO WHATSAPP
                </button>
            </div>
        </div>
    </div>

    <!-- NOVO: Modal de Login do Admin -->
    <div id="adminLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl max-w-sm w-full p-8 shadow-2xl border border-gray-700">
            <h3 class="text-xl font-bold text-yellow-400 mb-4">Login do Administrador</h3>
            <p class="text-gray-400 mb-4">Use seu e-mail e senha para gerenciar a rifa.</p>
            
            <input type="email" id="adminEmailInput" placeholder="Seu e-mail" class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-4">
            <input type="password" id="adminPasswordInput" placeholder="Sua senha" class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
            
            <p id="adminLoginError" class="text-red-500 text-sm mt-2 hidden">E-mail ou senha incorretos!</p>
            
            <div class="flex gap-4 mt-6">
                <button onclick="closeAdminLoginModal()" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-md">Cancelar</button>
                <button onclick="handleAdminLogin()" class="w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-4 rounded-md">Entrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl max-w-md w-full p-8 shadow-2xl border border-red-500">
            <h3 id="confirmationTitle" class="text-xl font-bold text-yellow-400 mb-4"></h3>
            <p id="confirmationMessage" class="text-gray-300 mb-6"></p>

            <div id="confirmationTextInputWrapper" class="hidden mb-4">
                <label id="confirmationLabel" for="confirmationInput" class="block text-sm font-medium text-gray-300 mb-1"></label>
                <input type="text" id="confirmationInput" class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400">
            </div>

            <div class="flex gap-4 mt-6 justify-end">
                <button id="confirmCancelBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-md">Cancelar</button>
                <button id="confirmOkBtn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-md disabled:bg-red-900 disabled:cursor-not-allowed">Confirmar</button>
            </div>
        </div>
    </div>

     <!-- Modal de Relat√≥rio -->
    <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl max-w-2xl w-full max-h-[90vh] flex flex-col shadow-2xl border border-gray-700">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-yellow-400">Relat√≥rio da Rifa</h2>
                <button class="text-3xl text-gray-400 hover:text-yellow-400" onclick="closeReportModal()">&times;</button>
            </div>
            <div id="reportContent" class="p-8 flex-grow overflow-y-auto modal-scrollbar"></div>
            <div class="p-6 border-t border-gray-700 flex justify-end gap-4">
                <button onclick="printReport()" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-md">Imprimir</button>
                <button onclick="closeReportModal()" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-md">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-green-500 text-white py-2 px-6 rounded-lg shadow-lg z-50 transition-opacity duration-300">
        <p id="toastMessage"></p>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // =========================================================================================
        // SUAS CONFIGURA√á√ïES DO FIREBASE FORAM INSERIDAS AQUI
        const firebaseConfig = {
            apiKey: "AIzaSyDkFcAEsokLgqIEKzvbTu4RPx408I3lGP0",
            authDomain: "lotsrifa.firebaseapp.com",
            databaseURL: "https://lotsrifa-default-rtdb.firebaseio.com",
            projectId: "lotsrifa",
            storageBucket: "lotsrifa.firebasestorage.app",
            messagingSenderId: "235747133235",
            appId: "1:235747133235:web:b5467c971d6a327543a046",
            measurementId: "G-97G3V944KC"
        };
        // =========================================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const raffleDocRef = doc(db, "raffleData", "mainState");

        window.db = db;
        window.raffleDocRef = raffleDocRef;
        window.auth = auth;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
    </script>
    
    <script>
        const NUMBERS_PER_RAFFLE = 350;
        const INITIAL_START_NUMBER = 9801;
        const WHATSAPP_NUMBER = "5531999121383";

        let selectedNumbers = [];
        let soldNumbersByRound = {};
        let lockedRounds = [];
        let raffleRound = 0;
        let isUserAdmin = false;
        let isInitialLoad = true; // Flag para a tela de carregamento

        // --- FUN√á√ïES DE CONTROLE DO FIREBASE ---

        async function saveStateToFirestore() {
            if (!isUserAdmin) {
                showToast("A√ß√£o n√£o permitida.", true);
                return;
            }
            if (!window.raffleDocRef) return;
            try {
                await window.setDoc(window.raffleDocRef, {
                    soldNumbersByRound: soldNumbersByRound,
                    raffleRound: raffleRound,
                    lockedRounds: lockedRounds
                });
            } catch (error) {
                console.error("Erro ao salvar no Firestore: ", error);
                showToast("Erro de conex√£o ao salvar.", true);
            }
        }
        
        function setupRealtimeListener() {
             if (!window.raffleDocRef) {
                setTimeout(setupRealtimeListener, 100);
                return;
            }
            window.onSnapshot(window.raffleDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    soldNumbersByRound = data.soldNumbersByRound || {};
                    raffleRound = data.raffleRound || 0;
                    lockedRounds = data.lockedRounds || [];
                } else {
                    console.log("Nenhum dado no Firestore. Um admin precisa fazer login e salvar para criar o estado inicial.");
                }
                
                // Esconde a tela de carregamento na primeira vez que os dados chegam
                if (isInitialLoad) {
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 500); // Espera a transi√ß√£o de opacidade terminar
                    isInitialLoad = false;
                }

                updateRaffleInfo();
                if (!document.getElementById('numbersModal').classList.contains('hidden')) {
                    generateNumbersGrid();
                }
            });
        }
        
        // --- FUN√á√ïES DE AUTENTICA√á√ÉO E ADMIN ---
        
        function setupAuthListener() {
            if (!window.onAuthStateChanged) {
                setTimeout(setupAuthListener, 100);
                return;
            }
            window.onAuthStateChanged(window.auth, user => {
                if (user) {
                    // Usu√°rio est√° logado
                    isUserAdmin = true;
                    document.getElementById('adminPanel').classList.remove('hidden');
                    document.getElementById('adminUserEmail').textContent = user.email;
                } else {
                    // Usu√°rio est√° deslogado
                    isUserAdmin = false;
                    document.getElementById('adminPanel').classList.add('hidden');
                }
                updateRaffleInfo();
            });
        }

        function openAdminLoginModal() {
            document.getElementById('adminLoginModal').classList.remove('hidden');
            document.getElementById('adminEmailInput').focus();
            document.getElementById('adminLoginError').classList.add('hidden');
        }

        function closeAdminLoginModal() {
            document.getElementById('adminLoginModal').classList.add('hidden');
        }
        
        async function handleAdminLogin() {
            const email = document.getElementById('adminEmailInput').value;
            const password = document.getElementById('adminPasswordInput').value;
            const errorEl = document.getElementById('adminLoginError');

            try {
                await window.signInWithEmailAndPassword(window.auth, email, password);
                showToast("Login bem-sucedido!");
                closeAdminLoginModal();
            } catch (error) {
                console.error("Erro de login:", error.code);
                errorEl.classList.remove('hidden');
            }
        }
        
        async function handleAdminLogout() {
            try {
                await window.signOut(window.auth);
                showToast("Voc√™ saiu da sua conta.");
            } catch (error) {
                console.error("Erro ao sair:", error);
                showToast("Erro ao tentar sair.", true);
            }
        }

        // --- FUN√á√ïES DE INTERFACE E L√ìGICA DA RIFA ---

        function updateRaffleInfo() {
            const startNumber = INITIAL_START_NUMBER + (raffleRound * NUMBERS_PER_RAFFLE);
            const endNumber = startNumber + NUMBERS_PER_RAFFLE - 1;
            const infoEl = document.getElementById('raffleInfo');
            const isCurrentRoundLocked = lockedRounds.includes(raffleRound);
            
            let status = isCurrentRoundLocked ? '<span class="text-red-400 font-bold">[FINALIZADA]</span>' : '<span class="text-green-400 font-bold">[EM ANDAMENTO]</span>';
            infoEl.innerHTML = `Rodada #${raffleRound + 1} ${status} | N√∫meros para sorteio de ${startNumber} a ${endNumber}`;
            
            if(document.getElementById('reportRound')) {
                document.getElementById('reportRound').value = raffleRound + 1;
            }
            if(isUserAdmin) {
                document.getElementById('finalizeRaffleBtn').disabled = isCurrentRoundLocked;
            }
        }

        function generateNumbersGrid() {
            const grid = document.getElementById('numbersGrid');
            grid.innerHTML = '';
            const startDisplayNumber = (raffleRound * NUMBERS_PER_RAFFLE) + 1;
            const endDisplayNumber = startDisplayNumber + NUMBERS_PER_RAFFLE - 1;
            const currentRoundSoldNumbers = soldNumbersByRound[raffleRound] || [];

            for (let i = startDisplayNumber; i <= endDisplayNumber; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.dataset.number = i;
                let buttonClasses = 'p-2 rounded-md font-bold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-yellow-400';

                if (currentRoundSoldNumbers.includes(i)) {
                    buttonClasses += ' bg-red-700 text-gray-300 cursor-not-allowed line-through';
                    button.disabled = true;
                } else if (selectedNumbers.includes(i)) {
                    buttonClasses += ' bg-green-600 text-white scale-110 shadow-lg';
                } else {
                    buttonClasses += ' bg-gray-700 text-white hover:bg-gray-600';
                }

                button.className = buttonClasses;
                button.onclick = () => toggleNumber(i);
                grid.appendChild(button);
            }
        }

        function toggleNumber(number) {
            if (isUserAdmin) {
                if (lockedRounds.includes(raffleRound)) {
                    showToast("Esta rodada est√° finalizada e n√£o pode ser alterada.", true);
                    return;
                }
                const currentRoundSoldNumbers = soldNumbersByRound[raffleRound] || [];
                const index = currentRoundSoldNumbers.indexOf(number);
                if (index > -1) {
                    currentRoundSoldNumbers.splice(index, 1);
                } else {
                    currentRoundSoldNumbers.push(number);
                }
                soldNumbersByRound[raffleRound] = currentRoundSoldNumbers;
                generateNumbersGrid();
                saveStateToFirestore();
            } else {
                const currentRoundSoldNumbers = soldNumbersByRound[raffleRound] || [];
                if (currentRoundSoldNumbers.includes(number)) return;
                
                const index = selectedNumbers.indexOf(number);
                if (index > -1) {
                    selectedNumbers.splice(index, 1);
                } else {
                    selectedNumbers.push(number);
                }
                updateSelectionSummary();
                generateNumbersGrid();
            }
        }

        function updateSelectionSummary() {
            document.getElementById('selectedCount').textContent = selectedNumbers.length;
            document.getElementById('totalPrice').textContent = selectedNumbers.length.toFixed(2).replace('.', ',');
            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.disabled = selectedNumbers.length === 0;
            const selectedDisplay = document.getElementById('selectedNumbersDisplay');
            if (selectedNumbers.length > 0) {
                selectedDisplay.innerHTML = `<strong>Seus n√∫meros:</strong> ${selectedNumbers.sort((a,b) => a - b).join(', ')}`;
            } else {
                selectedDisplay.innerHTML = '';
            }
        }

        function confirmSelection() {
            if (selectedNumbers.length === 0) return;
            const realSelectedNumbers = selectedNumbers.map(num => INITIAL_START_NUMBER + num - 1);
            const message = `Ol√°! Quero participar da *RIFA LOTS 2025* üêù (Rodada #${raffleRound + 1})\n\nüìã *N√∫meros escolhidos (display):* ${selectedNumbers.sort((a, b) => a - b).join(', ')}\nüî¢ *N√∫meros reais para sorteio:* ${realSelectedNumbers.sort((a,b) => a-b).join(', ')}\nüí∞ *Total a pagar:* R$ ${selectedNumbers.length.toFixed(2).replace('.', ',')}\nüìä *Quantidade:* ${selectedNumbers.length} n√∫meros\n\nAguardo os dados para PIX! üí≥`;
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            closeNumbersModal();
        }

        function openNumbersModal() {
            document.getElementById('numbersModal').classList.remove('hidden');
            const isCurrentRoundLocked = lockedRounds.includes(raffleRound);
            let modalTitle = 'üéØ ESCOLHA SEUS N√öMEROS';
            let showConfirmBtn = true;

            if(isUserAdmin) {
                 modalTitle = `ADMIN: EDITAR RODADA #${raffleRound + 1}`;
                 if(isCurrentRoundLocked) modalTitle += ' [FINALIZADA]';
                 showConfirmBtn = false;
            } else if(isCurrentRoundLocked) {
                modalTitle = `RIFA #${raffleRound + 1} FINALIZADA`;
                showConfirmBtn = false;
            }

            document.getElementById('modalTitle').textContent = modalTitle;
            document.getElementById('selectionSummary').style.display = isUserAdmin ? 'none' : 'block';
            document.getElementById('confirmBtn').style.display = showConfirmBtn ? 'block' : 'none';
            generateNumbersGrid();
        }

        function closeNumbersModal() {
            document.getElementById('numbersModal').classList.add('hidden');
             if (!isUserAdmin) {
                 selectedNumbers = [];
                 updateSelectionSummary();
             }
        }
        
        let confirmCallback = () => {};
        function showConfirmationModal(title, message, onConfirm, confirmationText = null) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            confirmCallback = onConfirm;
            const modal = document.getElementById('confirmationModal');
            const textInputWrapper = document.getElementById('confirmationTextInputWrapper');
            const textInput = document.getElementById('confirmationInput');
            const okBtn = document.getElementById('confirmOkBtn');
            const label = document.getElementById('confirmationLabel');
            if (confirmationText) {
                textInputWrapper.classList.remove('hidden');
                label.innerHTML = `Para confirmar, digite "<strong class="text-yellow-300">${confirmationText}</strong>" abaixo:`;
                textInput.value = '';
                okBtn.disabled = true;
                textInput.oninput = () => { okBtn.disabled = textInput.value !== confirmationText; };
            } else {
                textInputWrapper.classList.add('hidden');
                okBtn.disabled = false;
            }
            modal.classList.remove('hidden');
            document.getElementById('confirmCancelBtn').onclick = () => modal.classList.add('hidden');
            document.getElementById('confirmOkBtn').onclick = () => {
                if(okBtn.disabled) return;
                modal.classList.add('hidden');
                confirmCallback();
            };
        }

        function startNewRaffle() {
            showConfirmationModal("Iniciar Nova Rifa?", "Isso ir√° avan√ßar para a pr√≥xima rodada. Deseja continuar?",
                () => {
                    raffleRound++;
                    saveStateToFirestore();
                    showToast(`Nova rifa (Rodada #${raffleRound + 1}) iniciada!`);
                }
            );
        }

        function finalizeRaffle() {
             if (lockedRounds.includes(raffleRound)) { return; }
            showConfirmationModal("Finalizar Rifa Atual?", "Esta a√ß√£o ir√° bloquear a rodada atual (#" + (raffleRound + 1) + ") permanentemente. N√£o poder√° mais editar os n√∫meros.",
                () => {
                    lockedRounds.push(raffleRound);
                    saveStateToFirestore();
                    showToast(`Rodada #${raffleRound + 1} finalizada.`);
                }, "FINALIZAR"
            );
        }

        function resetAllData() {
            showConfirmationModal("RESETAR TUDO?", "Voc√™ est√° prestes a apagar TODOS os dados de TODAS as rifas. Esta a√ß√£o √© irrevers√≠vel.",
                () => {
                    soldNumbersByRound = {};
                    lockedRounds = [];
                    raffleRound = 0;
                    saveStateToFirestore();
                    showToast("Todos os dados foram resetados.", true);
                }, "RESETAR TUDO"
            );
        }

        function generateReport() {
            const roundInput = document.getElementById('reportRound');
            const roundNumber = parseInt(roundInput.value, 10);
            if (isNaN(roundNumber) || roundNumber < 1) {
                showToast("Por favor, insira um n√∫mero de rodada v√°lido.", true); return;
            }
            const roundIndex = roundNumber - 1;
            const reportSoldNumbers = soldNumbersByRound[roundIndex];
            if (!reportSoldNumbers || reportSoldNumbers.length === 0) {
                showToast(`Nenhum n√∫mero vendido para a rodada #${roundNumber}.`, true); return;
            }
            const totalSold = reportSoldNumbers.length;
            const totalRaised = totalSold * 1;
            const generationDate = new Date().toLocaleString('pt-BR');
            const startDisplayNumber = (roundIndex * NUMBERS_PER_RAFFLE) + 1;
            const endDisplayNumber = startDisplayNumber + NUMBERS_PER_RAFFLE - 1;
            const numbersHtml = reportSoldNumbers.sort((a,b) => a-b).map(n => `<span class="bg-gray-700 text-gray-200 py-1 px-2 rounded-md border border-gray-600">${n}</span>`).join('');
            const reportHtml = `<div class="report-print-area">...</div>`; // Conte√∫do omitido para brevidade
            document.getElementById('reportContent').innerHTML = `<div class="report-print-area">
                    <h3 class="text-xl font-bold text-white mb-4">Relat√≥rio da Rodada #${roundNumber}</h3>
                    <p class="text-gray-300 mb-2"><strong>Per√≠odo dos n√∫meros:</strong> ${startDisplayNumber} - ${endDisplayNumber}</p>
                    <p class="text-gray-300 mb-2"><strong>Gerado em:</strong> ${generationDate}</p>
                    <p class="text-gray-300 mb-2"><strong>Total de n√∫meros vendidos:</strong> ${totalSold}</p>
                    <p class="text-gray-300 mb-4"><strong>Total Arrecadado:</strong> R$ ${totalRaised.toFixed(2).replace('.', ',')}</p>
                    <div class="border-t border-gray-600 pt-4"><h4 class="font-semibold text-white mb-2">N√∫meros Vendidos:</h4><div class="flex flex-wrap gap-2 text-sm">${numbersHtml}</div></div></div>`;
            document.getElementById('reportModal').classList.remove('hidden');
        }
        
        function closeReportModal() { document.getElementById('reportModal').classList.add('hidden'); }
        function printReport() { window.print(); }
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toast.className = `fixed bottom-4 left-1/2 -translate-x-1/2 text-white py-2 px-6 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${isError ? 'bg-red-600' : 'bg-green-500'}`;
            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'opacity-0');
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => { toast.classList.add('hidden'); }, 500);
            }, 3000);
        }
        
        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            setupRealtimeListener();
            setupAuthListener();
            document.getElementById('numbersModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeNumbersModal(); });
            document.getElementById('adminPasswordInput').addEventListener('keyup', (e) => { if (e.key === 'Enter') handleAdminLogin(); });
            document.getElementById('adminEmailInput').addEventListener('keyup', (e) => { if (e.key === 'Enter') handleAdminLogin(); });
        });
        
    </script>
</body>
</html>

